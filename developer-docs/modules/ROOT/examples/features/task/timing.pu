@startuml timing
title Task Timing & Notifications

actor Tasker
participant System
actor Referee

note left of System
  **Time Parameters:**
  * **Matching Phase (matching_time_config):**
  * Open Deadline: Due Date - 24h (min)
  * Rematch Cutoff: Due Date - 14h
  * Cancel Deadline: Due Date - 12h
  * Evidence Warning: Due Date - 10min
  * Judgement Timeout Threshold: Due Date + 3h
  * Auto-Confirm Grace Period: N days (e.g., 3 days)
end note

== Task Creation ==
Tasker -> System: Open Task
System -> System: State: Request Pending

== Matching (Auto) ==
System -> Referee: Notification: Assigned to Task (Matched)
System -> System: State: Request Matched -> Accepted (Auto)

== Cancellation & Expiration ==
group Referee Cancels (before cancel deadline)
    Referee -> System: Cancel Assignment
    System -> System: Old request: Cancelled\nNew request: Pending â†’ re-match
    System -> Tasker: Notification: Reassigned / Pending
end

group Pending Request Expired (cron, past rematch cutoff)
    System -> System: Request: Expired\nRefund locked points
    System -> Tasker: Notification: Matching expired, points refunded
end

== Evidence Phase ==
group Evidence Deadline Warning
    System -> System: Check Due Date - 10min
    System -> Tasker: Notification: "Deadline in 10 mins"
end

group Evidence Submitted
    Tasker -> System: Submit Evidence
    System -> System: State: Judgement In Review
    System -> Referee: Notification: Review Requested
end

group Evidence Timeout (No Submission)
    System -> System: Check Due Date < Now
    System -> System: State: Judgement Evidence Timeout
    System -> System: Billing Trigger (Points Consumed / Paid)
    System -> Referee: Notification: Evidence Timeout (One-sided Win)
    System -> Tasker: Notification: "Evidence deadline passed. Payment processed."
end

== Judgement Phase ==
group Judgement Deadline Warning
    System -> System: Check (Due Date + 3h) - 10min ?
    System -> Referee: Notification: "Judgement Deadline Approaching"
end

group Referee Timeout (Judgement Timeout)
    note right of System
      If Evidence was submitted but Referee didn't judge
      by Timeout Threshold
    end note
    System -> System: Check Threshold < Now
    System -> System: State: Judgement Timeout
    System -> Tasker: Notification: Referee Timeout
    System -> Referee: Notification: Timeout penalty applied
    
    Tasker -> System: Confirm
    System -> System: State: Judgement Confirmed (Refund/Penalty)
end

@enduml
