= Evidence Submission
:sectnums:

This document describes the Evidence Submission feature, allowing Taskers to submit proof of work for their tasks.

== Overview

Once a Tasker accepts a Referee's request (or is matched), the Task enters a state where evidence can be submitted.
The evidence consists of a text description and up to 5 image assets.

The submission process uses **Cloudflare R2** for image storage and **Supabase** for metadata and status management.

== Prerequisites

* xref:features/task.adoc[Task Lifecycle] — Evidence is submitted within the context of an accepted Task Request.

== Upload Sequence

The following sequence diagram illustrates the secure upload flow, including:

.  Fetching Task details (to verify permissions).
.  Generating a presigned URL via Edge Function (which securely holds R2 credentials and public domain logic).
.  Direct upload to R2 (bypassing the application server for heavy lifting).
.  Submitting metadata (including R2 keys and public URLs) to the database via a secure RPC.

[plantuml]
----
include::example$features/evidence/upload_sequence.pu[]
----

== Key Components

=== Edge Function: `generate-upload-url`
* **Responsibility**:
** Validates user authentication and Task ownership.
** Generates a unique R2 Object Key (`evidence/...`).
** Generates a recursive 10-minute Presigned PUT URL.
** Constructs the `public_url` using the `R2_PUBLIC_DOMAIN` environment variable.
* **Security**: Ensures only the Tasker can upload files for their specific task.

=== RPC: `submit_evidence`
* **Responsibility**:
** Validates that the Judgement status is `awaiting_evidence` or `in_review`.
** Atomically transitions the Judgement status to `in_review`.
** Inserts records into `task_evidences` and `task_evidence_assets`.
* **Concurrency**: Uses database transactions to ensure data consistency.

=== Client: `EvidenceRepository`
* **Responsibility**:
** Orchestrates the flow: `Pick Images` -> `Get URL` -> `Upload to R2` -> `Submit Metadata`.
** Handles connection to the Edge Function using the Supabase SDK (ensuring correct environment routing).

== Notifications

When evidence is submitted or updated, a push notification is sent to the assigned Referee:

* **Insert** (new submission) → `notification_evidence_submitted`
* **Update** (resubmission after rejection) → `notification_evidence_updated`

This is handled by the `on_task_evidences_upserted_notify_referee` database trigger, which calls `notify_event()`.

== Evidence Timeout Detection

A cron job detects judgements where the Tasker failed to submit evidence before the due date.

=== Cron Job: `detect-evidence-timeouts`

* **Schedule**: Every 5 minutes (`*/5 * * * *`)
* **Function**: `detect_and_handle_evidence_timeouts()`
* **Condition**: Judgement status is `awaiting_evidence`, the task's `due_date` has passed, and no evidence exists (`task_evidences` has no matching row).
* **Action**: Sets judgement status to `evidence_timeout`.
* **Returns**: JSON with `success`, `timeout_count`, and `processed_at`.

== Evidence Timeout Settlement

When a judgement transitions to `evidence_timeout`, points are automatically settled and rewards granted.

=== Trigger: `on_evidence_timeout_settle`

* **Fires**: After update on `judgements` when `status` changes to `evidence_timeout`.
* **Function**: `settle_evidence_timeout()`

=== `settle_evidence_timeout()` Function

Actions (all within the trigger, atomic):

. Determine point cost via `get_point_for_matching_strategy()`.
. Settle points: `consume_points(tasker, cost, 'matching_settled')`.
. Grant reward: `grant_reward(referee, cost, 'evidence_timeout')`.
. Set `is_evidence_timeout_confirmed = true` on the judgement.
. Send notification to tasker (`notification_evidence_timeout`).
. Send notification to referee (`notification_evidence_timeout_reward`).

NOTE: The Tasker must still call `confirm_evidence_timeout()` RPC to set `is_confirmed = true`, which triggers the task closure check. See xref:features/judgement.adoc[Judgement — Confirm Evidence Timeout].

== Related Links

* xref:features/judgement.adoc[Judgement] — What happens after evidence is submitted (Referee approve/reject).
* xref:features/task.adoc[Task Lifecycle] — Full lifecycle including evidence timeouts.
