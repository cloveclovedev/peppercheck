= Task Lifecycle
:sectnums:

This document describes the lifecycle of a Task, including its interactions with Referee Requests and Judgements.

== Overview

The Task status moves primarily through three stages: `Draft`, `Open`, and `Closed` (or `Completed`).
Within the `Open` state, the `Referee Request` and `Judgement` lifecycles operate.

== Prerequisites

This is the foundational feature. Other features depend on this:

* xref:features/evidence.adoc[Evidence Submission] — Evidence submission within the Judgement lifecycle.
* xref:features/judgement.adoc[Judgement] — Referee approve/reject flow.
* xref:features/payment-and-reward.adoc[Payment & Reward Flow] — Point lock/settle mechanism.

== State Transition Diagram

The following diagram illustrates the state transitions for Tasks, Referee Requests, and Judgements.

[plantuml]
----
include::example$features/task/lifecycle.pu[]
----

=== State Descriptions

==== Task Status
* **Draft**: Task is being created. No points consumed yet.
* **Open**: Task is published. Referees can be matched.
* **Closed**: All process finished.

==== Request Status
* **Pending**: Waiting for a referee to be matched.
* **Matched**: System found a referee. (Auto-transits to Accepted in MVP).
* **Accepted**: Referee accepted the request. Points reserved.
* **Cancelled**: Referee cancelled assignment. New request created for re-matching.
* **Expired**: Pending request expired (past rematch cutoff). Points refunded.
* **Closed**: Request finished (either Judgement Confirmed or Evidence Timeout).

==== Judgement Status
* **Awaiting Evidence**: Initial state. Waiting for Tasker to submit evidence.
* **In Review**: Evidence submitted. Referee is reviewing.
* **Approved**: Referee approved the task. Tasker confirmation required.
* **Rejected**: Referee rejected. Tasker can update evidence (once, before due date).
* **Review Timeout**: Referee failed to make a judgement in time.
* **Evidence Timeout**: Tasker failed to submit evidence in time.
* **Confirmed**: Final state. Judgement is finalized.

== Timeline and Notifications

Notifications and state changes occur based on time limits (timeouts).

[plantuml]
----
include::example$features/task/timing.pu[]
----

== Time Constraints

All matching time constraints live in the `matching_time_config` singleton table with a CHECK constraint enforcing `open_deadline > rematch_cutoff > cancel_deadline`.

[cols="1,1,2"]
|===
| Parameter | Default | Purpose

| `open_deadline_hours` | 24 | Min hours before due_date to open a task
| `cancel_deadline_hours` | 12 | Hours before due_date until referee can cancel
| `rematch_cutoff_hours` | 14 | Hours before due_date until system retries matching; past this, pending requests expire with refund
|===

The rematch cutoff (14h) is the binding constraint -- a referee assigned overnight may not notice the assignment before due_date.

== Points and Closure

* Points are **locked** when a Task is opened and **settled** when each judgement is confirmed. See xref:features/payment-and-reward.adoc[Payment & Reward Flow] for details.
* A Task transitions to `Closed` when **all judgements are confirmed** (`is_confirmed = true`), not when requests are closed.
* To prevent tasks from hanging indefinitely, the system auto-confirms if the Tasker takes no action within a grace period after the due date.
