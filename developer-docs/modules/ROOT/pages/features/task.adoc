= Task Lifecycle
:sectnums:

This document describes the lifecycle of a Task, including its interactions with Referee Requests and Judgements.

== Overview

The Task status moves primarily through three stages: `Draft`, `Open`, and `Closed` (or `Completed`).
Within the `Open` state, the `Referee Request` and `Judgement` lifecycles operate.

== Prerequisites

This is the foundational feature. Other features depend on this:

* xref:features/evidence.adoc[Evidence Submission] — Evidence submission within the Judgement lifecycle.
* xref:features/judgement.adoc[Judgement] — Referee approve/reject flow.
* xref:features/payment-and-reward.adoc[Payment & Reward Flow] — Point consumption at task creation.

== State Transition Diagram

The following diagram illustrates the state transitions for Tasks, Referee Requests, and Judgements.

[plantuml]
----
include::example$features/task/lifecycle.pu[]
----

=== State Descriptions

==== Task Status
* **Draft**: Task is being created. No points consumed yet.
* **Open**: Task is published. Referees can be matched.
* **Closed**: All process finished.

==== Request Status
* **Pending**: Waiting for a referee to be matched.
* **Matched**: System found a referee. (Auto-transits to Accepted in MVP).
* **Accepted**: Referee accepted the request. Points reserved.
* **Closed**: Request finished (either Judgement Confirmed or Evidence Timeout).

==== Judgement Status
* **Awaiting Evidence**: Initial state. Waiting for Tasker to submit evidence.
* **In Review**: Evidence submitted. Referee is reviewing.
* **Approved**: Referee approved the task. Tasker confirmation required.
* **Rejected**: Referee rejected. Tasker can update evidence (once, before due date).
* **Review Timeout**: Referee failed to make a judgement in time.
* **Evidence Timeout**: Tasker failed to submit evidence in time.
* **Confirmed**: Final state. Judgement is finalized.

== Timeline and Notifications

Notifications and state changes occur based on time limits (timeouts).

[plantuml]
----
include::example$features/task/timing.pu[]
----

== Point System Considerations

* **Point Lock (at Task Creation)**:
** When a Task is opened, points are **locked** via `lock_points()` with reason `matching_lock`.
** The Tasker's `point_wallets.locked` column increases; `balance` is unchanged.
** Available balance = `balance - locked`.

* **Point Settlement (at Judgement Confirmation)**:
** When the Tasker confirms a judgement (via `confirm_judgement_and_rate_referee`), locked points are **settled** via `consume_points()` with reason `matching_settled`.
** Both `balance` and `locked` decrease.
** A reward is simultaneously granted to the Referee via `grant_reward()`.

* **Point Unlock (on Failure)**:
** If matching fails or the task is cancelled before confirmation, locked points are **unlocked** via `unlock_points()` with reason `matching_unlock`.
** The `locked` column decreases; `balance` remains unchanged (points return to available).

* **System Auto-Confirm**:
** To prevent tasks from hanging indefinitely in Approved, Rejected, or Timeout states, the system will automatically transition to Confirmed if the Tasker takes no action.
** Condition: `Now > Due Date + N days` (where N is a grace period, e.g., 3 days).
** **Rating**: In case of Auto-Confirm, no rating is applied (treated as NULL) to be neutral.

== Task Closure

A Task transitions to `Closed` status when **all judgements are confirmed** (`is_confirmed = true`).

* **Trigger**: `on_all_judgements_confirmed_close_task` — fires after a judgement's `is_confirmed` changes from `false` to `true`.
* **Function**: `close_task_if_all_judgements_confirmed()` — locks the task row, checks if any judgement for this task still has `is_confirmed = false`, and sets the task status to `closed` if all are confirmed.

This means the task does not close when requests are closed, but when the Tasker has confirmed every judgement outcome (either via `confirm_judgement_and_rate_referee` or `confirm_evidence_timeout`).
