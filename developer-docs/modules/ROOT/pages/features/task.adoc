= Task Lifecycle
:sectnums:

This document describes the lifecycle of a Task, including its interactions with Referee Requests and Judgements.

== Overview

The Task status moves primarily through three stages: `Draft`, `Open`, and `Closed` (or `Completed`).
Within the `Open` state, the `Referee Request` and `Judgement` lifecycles operate.

== Prerequisites

This is the foundational feature. Other features depend on this:

* xref:features/evidence.adoc[Evidence Submission] — Evidence submission within the Judgement lifecycle.
* xref:features/judgement.adoc[Judgement] — Referee approve/reject flow.
* xref:features/payment-and-reward.adoc[Payment & Reward Flow] — Point consumption at task creation.

== State Transition Diagram

The following diagram illustrates the state transitions for Tasks, Referee Requests, and Judgements.

[plantuml]
----
include::example$features/task/lifecycle.pu[]
----

=== State Descriptions

==== Task Status
* **Draft**: Task is being created. No points consumed yet.
* **Open**: Task is published. Referees can be matched.
* **Closed**: All process finished.

==== Request Status
* **Pending**: Waiting for a referee to be matched.
* **Matched**: System found a referee. (Auto-transits to Accepted in MVP).
* **Accepted**: Referee accepted the request. Points reserved.
* **Closed**: Request finished (either Judgement Confirmed or Evidence Timeout).

==== Judgement Status
* **`awaiting_evidence`**: Initial state. Waiting for Tasker to submit evidence.
* **`in_review`**: Evidence submitted. Referee is reviewing.
* **`approved`**: Referee approved the task. Tasker confirmation required.
* **`rejected`**: Referee rejected. Tasker can update evidence (once, before due date).
* **`review_timeout`**: Referee failed to make a judgement in time.
* **`evidence_timeout`**: Tasker failed to submit evidence in time.
* **Confirmed**: (`is_confirmed = true`) Final state. Judgement is finalized.

== Timeline and Notifications

Notifications and state changes occur based on time limits (timeouts).

[plantuml]
----
include::example$features/task/timing.pu[]
----

== Point System Considerations

* **Point Consumption (at Task Creation)**:
** When a Task is opened, points are consumed via `matching_request` ledger entry.
** If the matching fails or task is cancelled, points are refunded via `matching_refund`.

* **Point Finalization**:
** Points consumed at task creation are final once the Task reaches `Closed` state.

* **Refunds**:
** If `review_timeout` occurs, reserved points may be refunded depending on policy.

* **System Auto-Confirm**:
** To prevent tasks from hanging indefinitely in `approved`, `rejected`, or timeout states, the system will automatically transition to Confirmed if the Tasker takes no action.
** Condition: `Now > Due Date + N days` (where N is a grace period, e.g., 3 days).
** **Rating**: In case of Auto-Confirm, no rating is applied (treated as NULL) to be neutral.
