name: deploy-beta

on:
  workflow_dispatch:
  push:
    branches:
      - 'beta/v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  supabase-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to beta project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.BETA_SUPABASE_DB_PASSWORD }}
        run: supabase link --project-ref ${{ secrets.BETA_SUPABASE_PROJECT_ID }}

      - name: Push database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.BETA_SUPABASE_DB_PASSWORD }}
        run: supabase db push

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: supabase functions deploy --project-ref ${{ secrets.BETA_SUPABASE_PROJECT_ID }} --use-api

  flutter-build-distribute:
    needs: supabase-deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./peppercheck_flutter
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: stable
          cache: true

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install dependencies
        run: flutter pub get

      - name: Generate staging env file
        run: |
          cat > assets/env/.env.staging <<EOF
          SUPABASE_URL=https://${{ secrets.BETA_SUPABASE_PROJECT_ID }}.supabase.co
          SUPABASE_ANON_KEY=${{ secrets.BETA_SUPABASE_PUBLISHABLE_KEY }}
          STRIPE_PUBLISHABLE_KEY=${{ secrets.BETA_STRIPE_PUBLISHABLE_KEY }}
          WEB_DASHBOARD_URL=https://staging.peppercheck.dev/dashboard
          EOF

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF

      - name: Build staging APK
        run: flutter build apk --release -t lib/main_staging.dart

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}

      - name: Upload to Firebase App Distribution
        run: |
          npm install -g firebase-tools
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app "${{ secrets.FIREBASE_APP_ID }}" \
            --groups "internal-testers" \
            --release-notes "Beta build from ${{ github.ref_name }} (${GITHUB_SHA::7})"

  webapp-deploy:
    needs: supabase-deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./peppercheck-webapp
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './peppercheck-webapp/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Set staging environment
        run: |
          cat > .env.local <<EOF
          NEXT_PUBLIC_SUPABASE_URL=https://${{ secrets.BETA_SUPABASE_PROJECT_ID }}.supabase.co
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=${{ secrets.BETA_SUPABASE_PUBLISHABLE_KEY }}
          EOF

      - name: Build and deploy to Cloudflare (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx opennextjs-cloudflare build && npx opennextjs-cloudflare deploy -- --env staging
