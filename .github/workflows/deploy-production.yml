name: deploy-production

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  supabase-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to production project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_SUPABASE_DB_PASSWORD }}
        run: supabase link --project-ref ${{ secrets.PROD_SUPABASE_PROJECT_ID }}

      - name: Push database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.PROD_SUPABASE_DB_PASSWORD }}
        run: supabase db push

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: supabase functions deploy --project-ref ${{ secrets.PROD_SUPABASE_PROJECT_ID }} --use-api

  flutter-build:
    needs: supabase-deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./peppercheck_flutter
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: stable
          cache: true

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install dependencies
        run: flutter pub get

      - name: Generate production env file
        run: |
          cat > assets/env/.env.production <<EOF
          SUPABASE_URL=https://${{ secrets.PROD_SUPABASE_PROJECT_ID }}.supabase.co
          SUPABASE_ANON_KEY=${{ secrets.PROD_SUPABASE_ANON_KEY }}
          STRIPE_PUBLISHABLE_KEY=${{ secrets.PROD_STRIPE_PUBLISHABLE_KEY }}
          WEB_DASHBOARD_URL=https://peppercheck.dev/dashboard
          EOF

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF

      - name: Build production AAB
        run: flutter build appbundle --release -t lib/main_production.dart

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-aab
          path: peppercheck_flutter/build/app/outputs/bundle/release/app-release.aab

      # TODO: Add Google Play Store upload when ready (#272)
      # - name: Upload to Google Play (internal track)
      #   uses: r0adkll/upload-google-play@v1
      #   with:
      #     serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      #     packageName: dev.cloveclove.peppercheck
      #     releaseFiles: build/app/outputs/bundle/release/app-release.aab
      #     track: internal
      #     status: completed

  webapp-deploy:
    needs: supabase-deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./peppercheck-webapp
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './peppercheck-webapp/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Set production environment
        run: |
          cat > .env.local <<EOF
          NEXT_PUBLIC_SUPABASE_URL=https://${{ secrets.PROD_SUPABASE_PROJECT_ID }}.supabase.co
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=${{ secrets.PROD_SUPABASE_ANON_KEY }}
          EOF

      - name: Build and deploy to Cloudflare (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx opennextjs-cloudflare build && npx opennextjs-cloudflare deploy -- --env production --keep-vars
