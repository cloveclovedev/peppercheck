name: Apply labels from Issue Forms
on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Apply labels based on form fields
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            const labels = new Set(issue.labels.map(l => l.name));

            // Helper to add label if exists
            async function ensureLabel(name) {
              if (!labels.has(name)) {
                try {
                  await github.rest.issues.addLabels({
                    ...context.repo,
                    issue_number: issue.number,
                    labels: [name],
                  });
                  labels.add(name);
                } catch (e) {
                  // ignore if label doesn't exist
                  core.info(`Label ${name} not found or already present`);
                }
              }
            }

            // Parse "Area (labels to apply)" dropdown (multiple)
            // It will appear in issue body as a list; catch both single/multi line formats.
            const areaMatch = body.match(/Area .*?\n+((?:- .+\n?)+)/i) || body.match(/Affected area .*?\n+((?:- .+\n?)+)/i) || body.match(/Topic .*?\n+((?:- .+\n?)+)/i);
            if (areaMatch) {
              const lines = areaMatch[1].split('\n').map(l => l.trim()).filter(Boolean);
              for (const line of lines) {
                const m = line.match(/^- (.+)$/);
                if (m) {
                  await ensureLabel(m[1].trim());
                }
              }
            }

            // Parse "Priority (label to apply)" dropdown (single)
            const prioMatch = body.match(/Priority .*?\n+(- .+)\n/i);
            if (prioMatch) {
              const m = prioMatch[1].match(/- (.+)$/);
              if (m) await ensureLabel(m[1].trim());
            }

            // Default priority to P2 if none present
            if (![...labels].some(l => /^priority\/P[0-3]$/.test(l))) {
              await ensureLabel('priority/P2');
            }

